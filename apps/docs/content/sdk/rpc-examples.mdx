# Reading and Deserializing RPC Data

This guide shows how to read and deserialize blockchain data using the APL SDK.

## Prerequisites

```typescript
import { 
  createRpcConnection, 
  TOKEN_PROGRAM_ID,
  MintUtil,
  TokenAccountUtil,
  AssociatedTokenUtil
} from '@repo/apl-sdk';

const rpcConnection = createRpcConnection('YOUR_RPC_URL');
```

## Reading Token Mints

To get all token mints in the program:

```typescript
// Get all accounts owned by the token program
const mints = await rpcConnection.getProgramAccounts(TOKEN_PROGRAM_ID);

// Process each mint account
for (const mint of mints) {
  try {
    const mintData = MintUtil.deserialize(
      Buffer.from(mint.account.data as Uint8Array)
    );
    
    if (!mintData.is_initialized) continue;
    
    console.log('Mint Address:', Buffer.from(mint.pubkey).toString('hex'));
    console.log('Decimals:', mintData.decimals);
    console.log('Total Supply:', mintData.supply.toString());
  } catch (error) {
    console.error('Failed to deserialize mint:', error);
  }
}
```

## Reading Token Accounts

To read a specific token account:

```typescript
// Derive the associated token account address
const associatedTokenPubkey = AssociatedTokenUtil.getAssociatedTokenAddress(
  mintPubkey,    // The mint's public key
  ownerPubkey    // The token account owner's public key
);

try {
  // Read the account data
  const tokenAccountInfo = await rpcConnection.readAccountInfo(
    associatedTokenPubkey
  );

  if (tokenAccountInfo?.data) {
    // Deserialize the account data
    const tokenAccount = TokenAccountUtil.deserialize(
      Buffer.from(tokenAccountInfo.data)
    );

    console.log('Balance:', tokenAccount.amount.toString());
    console.log('State:', ['Uninitialized', 'Initialized', 'Frozen'][tokenAccount.state]);
    
    // Check delegation
    if (tokenAccount.delegate) {
      console.log('Delegated Amount:', tokenAccount.delegated_amount.toString());
    }
  }
} catch (error) {
  console.error('Failed to read token account:', error);
}
```

## Error Handling

Always implement proper error handling:

```typescript
try {
  const tokenAccountInfo = await rpcConnection.readAccountInfo(pubkey);
  
  // Check if account exists
  if (!tokenAccountInfo?.data) {
    throw new Error('Account not found');
  }
  
  // Attempt deserialization
  const tokenAccount = TokenAccountUtil.deserialize(
    Buffer.from(tokenAccountInfo.data)
  );
  
  // Validate account state
  if (tokenAccount.state !== 1) { // 1 = Initialized
    throw new Error('Account not initialized');
  }
  
  // Process account data...
  
} catch (error) {
  if (error.message.includes('Account not found')) {
    // Handle missing account
  } else if (error.message.includes('Account not initialized')) {
    // Handle uninitialized account
  } else {
    // Handle other errors
    console.error('Operation failed:', error);
  }
}
```

## Type Definitions

For TypeScript users, here are the relevant types:

```typescript
interface MintData {
  is_initialized: boolean;
  decimals: number;
  mint_authority: Pubkey | null;
  freeze_authority: Pubkey | null;
  supply: bigint;
}

interface TokenAccountData {
  mint: Pubkey;
  owner: Pubkey;
  amount: bigint;
  delegate: Pubkey | null;
  state: number;
  delegated_amount: bigint;
  close_authority: Pubkey | null;
}
```

## Best Practices

1. Always check if accounts exist before attempting deserialization
2. Use try/catch blocks for error handling
3. Validate account state after deserialization
4. Use BigInt for token amounts to avoid precision issues
5. Check initialization status before processing accounts
