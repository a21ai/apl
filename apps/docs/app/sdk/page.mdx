# APL SDK

## Overview

The APL SDK provides a TypeScript interface for creating and managing tokens on the Arch network.

## Installation

```sh npm2yarn copy
npm install @a21/apl-sdk
```

## Reading RPC Data

You can use the SDK to read data from the Arch network. Here's a complete example of reading token accounts and balances:

```typescript filename="list-tokens.ts" copy
import { RpcConnection } from "@repo/arch-sdk";
import { MintUtil, TOKEN_PROGRAM_ID, TokenAccountUtil, AssociatedTokenUtil } from "@a21/apl-sdk";

const main = async () => {
  const rpc = new RpcConnection("https://rpc-gamma.test.arch.network/");

  // Fetch token accounts
  const tokens = await rpc.getProgramAccounts(TOKEN_PROGRAM_ID, {
    DataSize: 82,
  });

  tokens.forEach(async (token) => {
    try {
      // Deserialize token account
      const mint = MintUtil.deserialize(Buffer.from(token.account.data));
      if (!mint.is_initialized) return;

      console.log('\nToken:', Buffer.from(token.pubkey).toString('hex'));
      console.log('Decimals:', mint.decimals);
      console.log('Total Supply:', mint.supply.toString());

      // Example: Reading associated token account
      const associatedTokenPubkey = AssociatedTokenUtil.getAssociatedTokenAddress(
        token.pubkey,
        ownerPubkey
      );

      const tokenAccountInfo = await rpc.readAccountInfo(associatedTokenPubkey);
      if (tokenAccountInfo?.data) {
        const tokenAccount = TokenAccountUtil.deserialize(
          Buffer.from(tokenAccountInfo.data)
        );
        console.log('Balance:', tokenAccount.amount.toString());
        console.log('State:', ['Uninitialized', 'Initialized', 'Frozen'][tokenAccount.state]);
        
        if (tokenAccount.delegate) {
          console.log('Delegated Amount:', tokenAccount.delegated_amount.toString());
        }
      }
    } catch (error) {
      console.error('Failed to read token data:', error);
    }
  });
};

main();
```

## Token Operations

The APL SDK provides core token operations with minimal setup required. Each operation that creates new accounts requires a valid UTXO with sufficient funds.

### Creating Tokens

```typescript filename="create-token.ts" copy
import { Pubkey } from "@saturnbtcio/arch-sdk";
import { initializeMintTx, Keypair } from "@a21/apl-sdk";

const tx = await initializeMintTx(
  mintKeypair, // Keypair for the new mint account
  utxo, // UTXO for account creation
  9, // Decimals (default)
  mintAuthority, // Mint authority public key
  null, // Optional freeze authority
  signer // Transaction signing callback
);

// Send transaction and wait for confirmation
const result = await rpcConnection.sendTransaction(tx);
await waitForConfirmation(rpcConnection, result);
```

### Creating Associated Token Accounts

```typescript filename="create-account.ts" copy
import { Pubkey } from "@repo/arch-sdk";
import { associatedTokenTx } from "@repo/apl-sdk";

const tx = await associatedTokenTx(
  utxo, // UTXO for account creation
  associatedToken, // Associated token account pubkey
  ownerPubkey, // Owner's public key
  mintPubkey, // Token mint address
  signer // Transaction signing callback
);

// Send transaction and wait for confirmation
const result = await rpcConnection.sendTransaction(tx);
await waitForConfirmation(rpcConnection, result);
```

### Minting Tokens

```typescript filename="mint-tokens.ts" copy
import { Pubkey } from "@repo/arch-sdk";
import { mintToTx } from "@repo/apl-sdk";

try {
  // Verify recipient token account exists
  const recipientTokenInfo = await rpcConnection.readAccountInfo(recipientPubkey);
  if (!recipientTokenInfo?.data) {
    throw new Error('Recipient token account does not exist');
  }

  const tx = await mintToTx(
    mintPubkey, // Token mint address
    recipientPubkey, // Recipient token account
    amount, // Amount to mint
    mintAuthority, // Mint authority public key
    signer // Transaction signing callback
  );

  // Send transaction and wait for confirmation
  const result = await rpcConnection.sendTransaction(tx);
  await waitForConfirmation(rpcConnection, result);
} catch (error) {
  console.error('Mint failed:', error);
  throw error;
}
```

### Transferring Tokens

```typescript filename="transfer-tokens.ts" copy
import { Pubkey } from "@repo/arch-sdk";
import { transferTx } from "@repo/apl-sdk";

try {
  // Verify accounts exist
  const sourceTokenInfo = await rpcConnection.readAccountInfo(sourceTokenPubkey);
  if (!sourceTokenInfo?.data) {
    throw new Error('Source token account does not exist');
  }

  const recipientTokenInfo = await rpcConnection.readAccountInfo(destinationPubkey);
  if (!recipientTokenInfo?.data) {
    throw new Error('Recipient token account does not exist');
  }

  const tx = await transferTx(
    sourceTokenPubkey, // Source token account
    mintPubkey, // Token mint address
    destinationPubkey, // Destination token account
    ownerPubkey, // Owner of source account
    amount, // Amount to transfer
    9, // Decimals (default)
    signer // Transaction signing callback
  );

  // Send transaction and wait for confirmation
  const result = await rpcConnection.sendTransaction(tx);
  await waitForConfirmation(rpcConnection, result);
} catch (error) {
  console.error('Transfer failed:', error);
  throw error;
}
```

## Web Integration

For web applications, you'll need to implement a signer that works with your web wallet:

```typescript filename="web-signer.ts" copy
// Example web wallet signer
const webSigner = {
  signMessage: async (message: Uint8Array) => {
    // Implementation using web wallet (e.g., LaserEyes)
    return await window.wallet.signMessage(message);
  }
};

// Use the web signer in transactions
const tx = await transferTx(
  sourceTokenPubkey,
  mintPubkey,
  recipientTokenPubkey,
  ownerPubkey,
  amount,
  decimals,
  webSigner
);

// Send transaction and wait for confirmation
try {
  const result = await rpcConnection.sendTransaction(tx);
  
  // Wait for confirmation with timeout
  await Promise.race([
    waitForConfirmation(rpcConnection, result),
    new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Transaction timeout')), 30000)
    )
  ]);
} catch (error) {
  if (error.message === 'Transaction timeout') {
    console.error('Transaction timed out');
  }
  throw error;
}
```
